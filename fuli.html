<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>复利计算器</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
html, body { margin:0; padding:0; font-family:Arial,Helvetica,sans-serif; background:#f9f9f9; color:#111; height:100%; }
body { display:flex; flex-direction:column; }

.chart-container { height:50%; padding:10px; box-sizing:border-box; position:relative; }
canvas { width:100% !important; height:100% !important; display:block; border-radius:8px; }

#resultBox { 
  position:absolute; top:6px; left:50%; transform:translateX(-50%); 
  background:none; color:#007bff; font-size:14px; font-weight:bold; 
  pointer-events:none; 
}

.form { flex:1; padding:20px; box-sizing:border-box; display:flex; flex-direction:row; gap:20px; justify-content:center; align-items:flex-start; }

.input-group { display:flex; flex-direction:column; align-items:center; gap:8px; }
.input-label { font-weight:500; font-size:16px; }
.input-wrapper { display:flex; flex-direction:column; position:relative; }
.input-wrapper input { padding:8px; font-size:16px; border-radius:8px; border:1px solid #ccc; text-align:center; width:80px; }

.scroll-bar-vertical { width:80px; height:250px; background:rgba(0,0,0,0.05); border-radius:8px; position:relative; cursor:grab; overflow:hidden; touch-action:none; }
.scroll-bar-vertical .fill { position:absolute; bottom:0; width:100%; height:0%; border-radius:8px; background: linear-gradient(to top, #007bff, #00bfff); }
</style>
</head>
<body>

<div class="chart-container">
  <canvas id="balanceChart"></canvas>
  <div id="resultBox">--</div>
</div>

<div class="form">
  <div class="input-group">
    <span class="input-label">本金</span>
    <div class="input-wrapper">
      <input type="number" id="principal" value="1" min="1" max="99"/>
    </div>
    <div class="scroll-bar-vertical" id="principalScroll"><div class="fill"></div></div>
  </div>

  <div class="input-group">
    <span class="input-label">利率(%)</span>
    <div class="input-wrapper">
      <input type="number" id="rate" value="10" min="0.5" max="50" step="0.5"/>
    </div>
    <div class="scroll-bar-vertical" id="rateScroll"><div class="fill"></div></div>
  </div>

  <div class="input-group">
    <span class="input-label">期数</span>
    <div class="input-wrapper">
      <input type="number" id="periods" value="12" min="1" max="120"/>
    </div>
    <div class="scroll-bar-vertical" id="periodsScroll"><div class="fill"></div></div>
  </div>
</div>

<script>
function formatNumber(v){ return Number(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,','); }

let chart=null;
function calculate(){
  const pEl=document.getElementById('principal');
  const rEl=document.getElementById('rate');
  const nEl=document.getElementById('periods');

  if(!pEl.value || !rEl.value || !nEl.value){
    if(chart){ try{chart.destroy();}catch(e){} }
    const ctx=document.getElementById('balanceChart').getContext('2d');
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    document.getElementById('resultBox').textContent='--';
    return;
  }

  const principal=parseFloat(pEl.value);
  const rate=parseFloat(rEl.value)/100;
  const periods=parseInt(nEl.value);
  const balances=[], labels=[];
  for(let i=1;i<=periods;i++){
    balances.push(+(principal*Math.pow(1+rate,i)).toFixed(2));
    labels.push(i);
  }

  if(chart) chart.destroy();
  const ctx=document.getElementById('balanceChart').getContext('2d');
  chart=new Chart(ctx,{
    type:'line',
    data:{labels, datasets:[{label:'期末余额', data:balances, borderColor:'#007bff', backgroundColor:'rgba(0,123,255,0.2)', fill:false, tension:0.2, pointBackgroundColor:'#007bff'}]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        datalabels:{
          color:'#007bff',
          font:{size:14},
          formatter:function(value, context){
            // 交替上下显示
            context.align = (context.dataIndex % 2 === 0) ? 'top' : 'bottom';
            context.anchor = (context.dataIndex % 2 === 0) ? 'end' : 'start';
            return value.toFixed(2);
          }
        }
      },
      scales:{
        y:{beginAtZero:true, ticks:{callback:formatNumber, color:'#111'}, grid:{color:'#ddd'}},
        x:{ticks:{color:'#111'}, grid:{color:'#ddd'}}
      }
    },
    plugins:[ChartDataLabels]
  });

  const lastBalance=balances[balances.length-1];
  document.getElementById('resultBox').textContent=(lastBalance/principal).toFixed(2);
}

// 初始化输入和滑条
['principal','rate','periods'].forEach(id=>{
  const input=document.getElementById(id);
  const scroll=document.getElementById(id+'Scroll');
  const fill=scroll.querySelector('.fill');
  const min=parseFloat(input.min), max=parseFloat(input.max);
  const step=(id==='rate')?0.5:1;

  function updateFill(){ 
    const val=parseFloat(input.value)||0;
    const percent=Math.min(Math.max((val-min)/(max-min)*100,0),100);
    fill.style.height=percent+'%';
  }

  let startVal=0, startY=0;

  scroll.addEventListener('touchstart', e=>{
    e.preventDefault();
    fill.style.transition = ""; 
    startY = e.touches[0].clientY;
    startVal = parseFloat(input.value)||min;

    function moveHandler(ev){
      ev.preventDefault();
      const deltaY = ev.touches[0].clientY - startY;
      let newVal = startVal - deltaY/(scroll.clientHeight)*(max-min);
      if(id==='rate') newVal = Math.round(newVal*2)/2;
      else newVal = Math.round(newVal);
      newVal = Math.min(Math.max(newVal,min),max);
      input.value = newVal;
      calculate();
      updateFill();
    }

    function endHandler(){
      let finalVal = parseFloat(input.value);
      if(id==='rate') finalVal = Math.round(finalVal*2)/2;
      else finalVal = Math.round(finalVal);
      finalVal = Math.min(Math.max(finalVal,min),max);
      input.value = finalVal;
      calculate();

      fill.style.transition = "height 0.1s";
      updateFill();

      document.removeEventListener('touchmove', moveHandler);
      document.removeEventListener('touchend', endHandler);
    }

    document.addEventListener('touchmove', moveHandler, {passive:false});
    document.addEventListener('touchend', endHandler);
  });

  input.addEventListener('input', ()=>{
    calculate();
    updateFill();
  });

  updateFill();
});

window.addEventListener('load', calculate);
</script>

</body>
</html>
