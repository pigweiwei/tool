<script>
// ==================== Â§çÂà©ËÆ°ÁÆóÂô®ÈÄªËæëÔºà‰øùÊåÅÂéüÊ†∑Ôºâ ====================
function formatNumber(v){ 
  let str = v.toFixed(1); 
  return str.replace(/\B(?=(\d{4})+(?!\d))/g, ','); 
}

// ... ÁúÅÁï•ÂâçÈù¢ calculate() Á≠â‰øùÊåÅ‰∏çÂèò ...

// ÊªëÊù°ÂàùÂßãÂåñÔºàÂä†‰∫ÜÊñπÂêëÈîÅÂÆöÔºâ
['principal','rate','periods'].forEach(id=>{
  const input=document.getElementById(id);
  const scroll=document.getElementById(id+'Scroll');
  const fill=scroll.querySelector('.fill');
  const min=parseFloat(input.min), max=parseFloat(input.max);

  function updateFill(){ 
    const val=parseFloat(input.value)||0;
    const percent=Math.min(Math.max((val-min)/(max-min)*100,0),100);
    fill.style.height=percent+'%';
  }

  input.addEventListener('focus', ()=>{
    input.value='';
    calculate();
    fill.style.height='0%';
  });

  let startVal=0, startX=0, startY=0, dragDirection=null;

  scroll.addEventListener('touchstart', e=>{
    e.preventDefault();
    fill.style.transition = ""; 
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    startVal = parseFloat(input.value)||min;
    dragDirection = null;

    function moveHandler(ev){
      ev.preventDefault();
      const clientX = ev.touches[0].clientX;
      const clientY = ev.touches[0].clientY;

      if (dragDirection === null) {
        let dx = clientX - startX;
        let dy = clientY - startY;
        if (Math.abs(dy) > Math.abs(dx)) {
          dragDirection = "vertical";
        } else {
          dragDirection = "horizontal";
        }
      }

      if (dragDirection === "vertical") {
        const deltaY = clientY - startY;
        let newVal = startVal - deltaY/(scroll.clientHeight)*(max-min);
        if(id==='rate') newVal = Math.round(newVal*2)/2;
        else newVal = Math.round(newVal);
        newVal = Math.min(Math.max(newVal,min),max);
        input.value = newVal;
        calculate();
        updateFill();
      } else {
        // üëâ Ê®™ÂêëÊªëÂä®Êó∂Ôºå‰∏çÂ§ÑÁêÜÔºå‰∫§ÁªôÂØºËà™
      }
    }

    function endHandler(){
      if (dragDirection === "vertical") {
        let finalVal = parseFloat(input.value);
        if(id==='rate') finalVal = Math.round(finalVal*2)/2;
        else finalVal = Math.round(finalVal);
        finalVal = Math.min(Math.max(finalVal,min),max);
        input.value = finalVal;
        calculate();
        fill.style.transition = "height 0.1s";
        updateFill();
      }
      document.removeEventListener('touchmove', moveHandler);
      document.removeEventListener('touchend', endHandler);
    }

    document.addEventListener('touchmove', moveHandler, {passive:false});
    document.addEventListener('touchend', endHandler);
  });

  input.addEventListener('input', ()=>{
    calculate();
    updateFill();
  });

  updateFill();
});

window.addEventListener('load', calculate);

// ==================== Âè≥‰æßÂØºËà™ÈÄªËæëÔºà‰øùÊåÅÂéüÊ†∑Ôºâ ====================
const rightNav = document.getElementById('rightNav');
const overlay = document.getElementById('overlay');

function openNav(){ 
  rightNav.classList.add('expanded'); 
  overlay.classList.add('show'); 
}
function closeNav(){ 
  rightNav.classList.remove('expanded'); 
  overlay.classList.remove('show'); 
}

overlay.addEventListener('click', closeNav);

// ÊâãÂäøÊªëÂä®
let touchStartX=0, touchStartY=0;
document.addEventListener('touchstart', e=>{
  if(e.touches.length!==1) return;
  touchStartX=e.touches[0].clientX;
  touchStartY=e.touches[0].clientY;
});

document.addEventListener('touchend', e=>{
  if(e.changedTouches.length!==1) return;
  let touchEndX=e.changedTouches[0].clientX;
  let touchEndY=e.changedTouches[0].clientY;
  let deltaX = touchStartX - touchEndX;
  let deltaY = touchStartY - touchEndY;
  if(Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY)){
    if(deltaX > 0){ // Â∑¶Êªë
      openNav();
    } else { // Âè≥Êªë
      closeNav();
    }
  }
});
</script>
