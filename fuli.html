<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å¤åˆ©è®¡ç®—å™¨ + å³ä¾§å¯¼èˆª</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
/* ä½ çš„æ ·å¼ä¸å˜ï¼Œè¿™é‡Œçœç•¥ï¼Œç›´æ¥ç”¨ä½ ä¸Šé¢çš„ */
</style>
</head>
<body>
<!-- å›¾è¡¨å’Œè¡¨å• -->
<div class="chart-container">
  <canvas id="balanceChart"></canvas>
  <div id="topValues">
    <div id="resultBox">å€ç‡ï¼š--X</div>
    <div id="finalValue">ç»ˆå€¼ï¼š--</div>
  </div>
</div>

<div class="form">
  <div class="input-group">
    <span class="input-label">æœ¬é‡‘</span>
    <div class="input-wrapper">
      <input type="number" id="principal" value="1" min="1" max="99"/>
    </div>
    <div class="scroll-bar-vertical" id="principalScroll"><div class="fill"></div></div>
  </div>

  <div class="input-group">
    <span class="input-label">åˆ©ç‡(%)</span>
    <div class="input-wrapper">
      <input type="number" id="rate" value="10" min="0.5" max="50" step="0.5"/>
    </div>
    <div class="scroll-bar-vertical" id="rateScroll"><div class="fill"></div></div>
  </div>

  <div class="input-group">
    <span class="input-label">æœŸæ•°</span>
    <div class="input-wrapper">
      <input type="number" id="periods" value="12" min="1" max="120"/>
    </div>
    <div class="scroll-bar-vertical" id="periodsScroll"><div class="fill"></div></div>
  </div>
</div>

<!-- å³ä¾§å¯¼èˆª -->
<div class="right-nav" id="rightNav">
  <div class="nav-item">é¦–é¡µ</div>
  <div class="nav-item">ç›ˆäºæ¯”&èƒœç‡</div>
</div>

<div class="overlay" id="overlay"></div>

<script>
// =============== å¤åˆ©è®¡ç®—å™¨æ ¸å¿ƒé€»è¾‘ï¼ˆå’Œä½ åŸæ¥ä¸€è‡´ï¼‰ ===============
function formatNumber(v){ 
  let str = v.toFixed(1); 
  return str.replace(/\B(?=(\d{4})+(?!\d))/g, ','); 
}

let chart=null;
function calculate(){
  const pEl=document.getElementById('principal');
  const rEl=document.getElementById('rate');
  const nEl=document.getElementById('periods');
  if(!pEl.value || !rEl.value || !nEl.value){
    if(chart){ try{chart.destroy();}catch(e){} }
    const ctx=document.getElementById('balanceChart').getContext('2d');
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    document.getElementById('resultBox').textContent='å€ç‡ï¼š--X';
    document.getElementById('finalValue').textContent='ç»ˆå€¼ï¼š--';
    return;
  }
  const principal=parseFloat(pEl.value);
  const rate=parseFloat(rEl.value)/100;
  const periods=parseInt(nEl.value);
  const balances=[], labels=[];
  for(let i=1;i<=periods;i++){
    balances.push(+(principal*Math.pow(1+rate,i)).toFixed(1));
    labels.push(i);
  }
  if(chart) chart.destroy();
  const ctx=document.getElementById('balanceChart').getContext('2d');
  const minY = principal; 
  chart=new Chart(ctx,{
    type:'line',
    data:{labels, datasets:[{label:'æœŸæœ«ä½™é¢', data:balances, borderColor:'#1e90ff', backgroundColor:'rgba(30,144,255,0.2)', fill:false, tension:0.2, pointBackgroundColor:'#1e90ff'}]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        datalabels:{
          color:'#1e90ff',
          font:{size:14},
          anchor:(context)=> ( (context.chart.data.datasets[0].data.length-1-context.dataIndex)%2===0 ? 'end':'start'),
          align:(context)=> ( (context.chart.data.datasets[0].data.length-1-context.dataIndex)%2===0 ? 'top':'bottom'),
          formatter:(value)=> formatNumber(value)
        }
      },
      layout:{padding:{top:30, right:30}},
      scales:{
        y:{beginAtZero:false, min:minY, ticks:{callback:formatNumber,color:'#eee'}, grid:{color:'#444'}},
        x:{ticks:{color:'#eee'}, grid:{color:'#444'}}
      }
    },
    plugins:[ChartDataLabels]
  });
  const lastBalance=balances[balances.length-1];
  document.getElementById('finalValue').textContent='ç»ˆå€¼ï¼š'+formatNumber(lastBalance);
  document.getElementById('resultBox').textContent='å€ç‡ï¼š'+(lastBalance/principal).toFixed(1)+'X';
}

// =============== æ»‘æ¡åˆå§‹åŒ–ï¼Œå¢åŠ æ–¹å‘åˆ¤å®š ===============
['principal','rate','periods'].forEach(id=>{
  const input=document.getElementById(id);
  const scroll=document.getElementById(id+'Scroll');
  const fill=scroll.querySelector('.fill');
  const min=parseFloat(input.min), max=parseFloat(input.max);

  function updateFill(){ 
    const val=parseFloat(input.value)||0;
    const percent=Math.min(Math.max((val-min)/(max-min)*100,0),100);
    fill.style.height=percent+'%';
  }

  input.addEventListener('focus', ()=>{
    input.value='';
    calculate();
    fill.style.height='0%';
  });

  let startVal=0, startX=0, startY=0, dragDirection=null;

  scroll.addEventListener('touchstart', e=>{
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    dragDirection = null;
    startVal = parseFloat(input.value)||min;

    function moveHandler(ev){
      const dx = ev.touches[0].clientX - startX;
      const dy = ev.touches[0].clientY - startY;
      if(dragDirection===null){
        dragDirection = (Math.abs(dy)>Math.abs(dx)) ? 'vertical' : 'horizontal';
      }
      if(dragDirection==='vertical'){
        ev.preventDefault();
        let newVal = startVal - dy/(scroll.clientHeight)*(max-min);
        if(id==='rate') newVal = Math.round(newVal*2)/2;
        else newVal = Math.round(newVal);
        newVal = Math.min(Math.max(newVal,min),max);
        input.value = newVal;
        calculate();
        updateFill();
      }
      // ğŸ‘‰ å¦‚æœæ˜¯ horizontalï¼Œè¯´æ˜ç”¨æˆ·è¦å·¦å³æ»‘åŠ¨ï¼Œæ­¤æ—¶ä¸å¤„ç†ï¼Œè®©å¯¼èˆªé€»è¾‘æ¥ç®¡
    }

    function endHandler(){
      if(dragDirection==='vertical'){
        let finalVal = parseFloat(input.value);
        if(id==='rate') finalVal = Math.round(finalVal*2)/2;
        else finalVal = Math.round(finalVal);
        finalVal = Math.min(Math.max(finalVal,min),max);
        input.value = finalVal;
        calculate();
        fill.style.transition = "height 0.1s";
        updateFill();
      }
      document.removeEventListener('touchmove', moveHandler);
      document.removeEventListener('touchend', endHandler);
    }

    document.addEventListener('touchmove', moveHandler,{passive:false});
    document.addEventListener('touchend', endHandler);
  });

  input.addEventListener('input', ()=>{
    calculate();
    updateFill();
  });
  updateFill();
});

window.addEventListener('load', calculate);

// =============== å³ä¾§å¯¼èˆªé€»è¾‘ï¼ˆåŠ æ–¹å‘åˆ¤å®šï¼‰ ===============
const rightNav=document.getElementById('rightNav');
const overlay=document.getElementById('overlay');
function openNav(){ rightNav.classList.add('expanded'); overlay.classList.add('show'); }
function closeNav(){ rightNav.classList.remove('expanded'); overlay.classList.remove('show'); }
overlay.addEventListener('click', closeNav);

let navStartX=0, navStartY=0, navDirection=null;
document.addEventListener('touchstart', e=>{
  if(e.touches.length!==1) return;
  navStartX=e.touches[0].clientX;
  navStartY=e.touches[0].clientY;
  navDirection=null;
});
document.addEventListener('touchmove', e=>{
  if(e.touches.length!==1) return;
  if(navDirection===null){
    let dx=e.touches[0].clientX-navStartX;
    let dy=e.touches[0].clientY-navStartY;
    navDirection=(Math.abs(dx)>Math.abs(dy))?'horizontal':'vertical';
  }
});
document.addEventListener('touchend', e=>{
  if(e.changedTouches.length!==1) return;
  if(navDirection!=='horizontal') return; // åªå“åº”æ°´å¹³
  let deltaX=navStartX-e.changedTouches[0].clientX;
  if(Math.abs(deltaX)>50){
    if(deltaX>0){ openNav(); } else { closeNav(); }
  }
});
</script>
</body>
</html>
