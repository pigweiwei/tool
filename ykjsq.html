<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>盈亏计算器</title>
<style>
body {
  --bar-left1-bg: rgba(255,99,132,0.35);
  --bar-left1-border: rgba(255,99,132,0.6);
  --bar-left2-bg: rgba(54,162,235,0.35);
  --bar-left2-border: rgba(54,162,235,0.6);
  --bar-left3-bg: rgba(255,206,86,0.35);
  --bar-left3-border: rgba(255,206,86,0.6);
  --bar-left4-bg: rgba(75,192,192,0.35);
  --bar-left4-border: rgba(75,192,192,0.6);
  --bar-left5-bg: rgba(153,102,255,0.35);
  --bar-left5-border: rgba(153,102,255,0.6);
  --label-color: #eee;
  --bar-value-color: #fff;
  --checkbox-bg: #666;
  --checkbox-checked-bg: var(--bar-left4-bg);
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #2b2b2b;
  overflow: hidden;
}
.panel {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: row;
  position: relative;
  overflow: hidden;
  padding-top: 10px;
}
#calcResult {
  position: absolute;
  top: 45px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 20px;
  font-weight: bold;
  color: #fff;
  padding: 8px 20px;
  min-width: 120px;
  text-align: center;
  border-radius: 10px;
  background: rgba(60,60,60,0.3);
  backdrop-filter: blur(16px) saturate(160%);
  border: 1px solid rgba(255,255,255,0.15);
  box-shadow: 0 0 5px rgba(0,0,0,0.4), inset 0 0 5px rgba(255,255,255,0.05);
  pointer-events: none;
  z-index: 100;
}
.bar-container-horizontal {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
  gap: 20px;
  width: calc(100% - 20px);
  height: 100%;
  user-select: none;
  padding-left: 42px;
}
.bar-wrapper-horizontal {
  position: relative;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
  width: 100%;
  cursor: grab;
  touch-action: none;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  pointer-events: auto;
}
.bar-horizontal {
  height: 80px;
  width: 0;
  border-radius: 0 10px 10px 0;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  flex-direction: row;
  box-shadow: inset -5px 0 15px rgba(0,0,0,0.1), 8px 0 20px rgba(0,0,0,0.2);
  backdrop-filter: blur(15px);
  transition: width 0.05s ease-out;
  overflow: visible;
  position: relative;
}
.bar-horizontal.dragging {
  transition: none;
}
.bar-value-horizontal {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  font-weight: bold;
  color: var(--bar-value-color);
  z-index: 2;
  user-select: none;
  text-align: left;
  min-width: 80px;
  padding-left: 3px;
  pointer-events: none;
}
.label-horizontal {
  font-size: 14px;
  font-weight: bold;
  color: var(--label-color);
  user-select: none;
  transition: color 0.3s;
  position: absolute;
  left: -20px;
  writing-mode: vertical-rl;
  text-orientation: upright;
  pointer-events: none;
}
#leftBar1 { background: var(--bar-left1-bg); border: 1px solid var(--bar-left1-border); }
#leftBar2 { background: var(--bar-left2-bg); border: 1px solid var(--bar-left2-border); }
#leftBar3 { background: var(--bar-left3-bg); border: 1px solid var(--bar-left3-border); }
#leftBar4 { background: var(--bar-left4-bg); border: 1px solid var(--bar-left4-border); }
#leftBar5 { background: var(--bar-left5-bg); border: 1px solid var(--bar-left5-border); }
#profitLoss {
  position: absolute;
  right: 5px;
  top: 95px; /* 与 feeValueWrap 纵向对齐 */
  font-weight: bold;
  font-size: 14px;
  color: var(--label-color);
  pointer-events: none;
}
#feeDisplay {
  position: absolute;
  right: 5px;
  top: 125px; /* 与 feeMinWrap 纵向对齐 */
  font-weight: bold;
  font-size: 14px;
  color: var(--label-color);
  pointer-events: none;
}
#feeValueWrap {
  position: absolute;
  left: 5px;
  top: 95px;
}
#feeMinWrap {
  position: absolute;
  left: 5px;
  top: 125px;
}
#feeValueWrap div, #feeMinWrap div {
  display: flex;
  align-items: center;
  gap: 5px;
}
#feeValueWrap span,
#feeMinWrap label {
  font-size: 16px;
  color: var(--label-color);
  line-height: 20px;
  user-select: none;
  cursor: default;
}
#feeMinCheck {
  width: 16px;
  height: 16px;
  appearance: none;
  background: var(--checkbox-bg);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 4px;
  cursor: pointer;
  position: relative;
}
#feeMinCheck:checked {
  background: var(--checkbox-checked-bg);
  border-color: var(--bar-left4-border);
}
#feeMinCheck:checked::after {
  content: '✔';
  color: var(--bar-value-color);
  font-size: 12px;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
@media (max-width: 768px) {
  body {
    font-size: 16px;
  }
  .panel {
    padding-top: 100px;
  }
  #calcResult {
    top: 45px;
    font-size: 20px;
    padding: 8px 20px;
    min-width: 120px;
    border-radius: 10px;
  }
  .bar-container-horizontal {
    gap: 20px;
    padding-left: 22px;
    width: calc(100% - 20px);
  }
  .bar-wrapper-horizontal {
    cursor: auto;
  }
  .bar-horizontal {
    height: 90px;
    border-radius: 0 10px 10px 0;
  }
  .bar-value-horizontal {
    font-size: 14px;
    min-width: 80px;
    padding-left: 3px;
  }
  .label-horizontal {
    font-size: 14px;
    left: -20px;
  }
  #profitLoss {
    right: 5px;
    top: 95px; /* 与 feeValueWrap 纵向对齐 */
  }
  #feeDisplay {
    right: 5px;
    top: 125px; /* 与 feeMinWrap 纵向对齐 */
  }
  #feeValueWrap {
    left: 5px;
    top: 95px;
  }
  #feeMinWrap {
    left: 5px;
    top: 125px;
  }
  #feeValueWrap span,
  #feeMinWrap label {
    font-size: 16px;
    line-height: 20px;
  }
  #feeMinCheck {
    width: 16px;
    height: 16px;
  }
  #feeMinCheck:checked::after {
    font-size: 12px;
  }
}
</style>
</head>
<body>
<div class="panel">
  <div class="bar-container-horizontal">
    <div class="bar-wrapper-horizontal"><div class="bar-horizontal" id="leftBar1"><div class="bar-value-horizontal" id="valLeft1">10000</div></div><div class="label-horizontal">本金</div></div>
    <div class="bar-wrapper-horizontal"><div class="bar-horizontal" id="leftBar2"><div class="bar-value-horizontal" id="valLeft2">5%</div></div><div class="label-horizontal">每次止损</div></div>
    <div class="bar-wrapper-horizontal"><div class="bar-horizontal" id="leftBar3"><div class="bar-value-horizontal" id="valLeft3">10</div></div><div class="label-horizontal">交易笔数</div></div>
    <div class="bar-wrapper-horizontal"><div class="bar-horizontal" id="leftBar4"><div class="bar-value-horizontal" id="valLeft4">2</div></div><div class="label-horizontal">盈亏比</div></div>
    <div class="bar-wrapper-horizontal"><div class="bar-horizontal" id="leftBar5"><div class="bar-value-horizontal" id="valLeft5">50%</div></div><div class="label-horizontal">胜率</div></div>
  </div>
  <div class="calc-result" id="calcResult">0</div>
  <div id="profitLoss">盈亏：0%</div>
  <div id="feeDisplay">手续费: 1</div>
  <div id="feeValueWrap">
    <div><span id="feeValue">1</span><span class="feeText">/万</span></div>
  </div>
  <div id="feeMinWrap">
    <div><input type="checkbox" id="feeMinCheck"><label for="feeMinCheck">免五</label></div>
  </div>
</div>
<script>
try {
// 格式化数字为万分位
function formatTenThousand(num) {
  try {
    const parts = Math.round(num).toString().split('');
    let result = '';
    let len = parts.length;
    for (let i = 0; i < len; i++) {
      result += parts[i];
      if ((len - i - 1) % 4 === 0 && i !== len - 1) result += ',';
    }
    return result;
  } catch (e) {
    console.error('Error in formatTenThousand:', e);
    return num.toString();
  }
}

// 节流函数
function throttle(fn, wait) {
  let lastCall = 0;
  return function (...args) {
    const now = performance.now();
    if (now - lastCall >= wait) {
      lastCall = now;
      return fn(...args);
    }
  };
}

// 线性插值函数
function lerp(start, end, alpha) {
  return start + (end - start) * alpha;
}

// 更新柱子宽度
function updateHeight(bar, valueDisplay, value, maxVal, type, isHorizontal = false, barId = '') {
  requestAnimationFrame(() => {
    try {
      if (!bar || !valueDisplay) {
        console.error('Invalid bar or valueDisplay:', { bar, valueDisplay, barId });
        return;
      }
      const container = bar.parentElement;
      if (!container) {
        console.error('Container not found for bar:', bar, barId);
        return;
      }
      const maxDimension = isHorizontal ? container.clientWidth * 0.7 : container.clientHeight * 0.7;
      const displayValue = barId === 'leftBar4' ? Math.round(value / 0.5) * 0.5 : value;
      const dimension = Math.min((value / maxVal) * maxDimension, maxDimension);
      if (isHorizontal) {
        bar.style.width = `${dimension}px`;
        valueDisplay.style.left = `${dimension}px`;
      } else {
        bar.style.height = `${dimension}px`;
      }
      if (type === 'int') {
        valueDisplay.textContent = formatTenThousand(Math.round(displayValue));
      } else if (type === 'percent') {
        valueDisplay.textContent = `${Math.round(displayValue)}%`;
      } else if (type === 'float') {
        valueDisplay.textContent = displayValue.toFixed(1);
      }
    } catch (e) {
      console.error('Error in updateHeight:', e, barId);
    }
  });
}

// 左侧柱子数据
const leftBars = [
  { bar: document.getElementById('leftBar1'), display: document.getElementById('valLeft1'), value: 10000, step: 10000, max: 1000000, type: 'int' },
  { bar: document.getElementById('leftBar2'), display: document.getElementById('valLeft2'), value: 5, step: 1, max: 50, type: 'percent' },
  { bar: document.getElementById('leftBar3'), display: document.getElementById('valLeft3'), value: 10, step: 1, max: 100, type: 'int' },
  { bar: document.getElementById('leftBar4'), display: document.getElementById('valLeft4'), value: 2, step: 0.5, max: 10, type: 'float' },
  { bar: document.getElementById('leftBar5'), display: document.getElementById('valLeft5'), value: 50, step: 1, max: 100, type: 'percent' }
];

// 验证 DOM 元素
leftBars.forEach((b, i) => {
  if (!b.bar || !b.display) {
    console.error(`Invalid DOM element for bar ${i + 1}:`, { bar: b.bar, display: b.display });
  }
});

// 费用相关
const feeValueSpan = document.getElementById('feeValue');
const feeTextSpan = document.querySelector('.feeText');
const profitLossSpan = document.getElementById('profitLoss');
const feeDisplaySpan = document.getElementById('feeDisplay');
const feeMinCheck = document.getElementById('feeMinCheck');
let feeValue = 1;
let lastResult = null;

// 验证费用相关 DOM
if (!feeValueSpan || !feeTextSpan || !profitLossSpan || !feeDisplaySpan || !feeMinCheck) {
  console.error('Missing fee-related DOM elements:', { feeValueSpan, feeTextSpan, profitLossSpan, feeDisplaySpan, feeMinCheck });
}

// 计算最终盈亏结果
function updateFinalResult() {
  try {
    let capital = leftBars[0].value;
    const stopLoss = leftBars[1].value / 100;
    const trades = leftBars[2].value;
    const profitLossRatio = leftBars[3].value;
    const winRate = leftBars[4].value / 100;
    const feeMin = feeMinCheck.checked;
    const feeRate = feeValue / 10000;

    let total = capital;
    let totalFee = 0;
    for (let i = 0; i < trades; i++) {
      const pl = winRate * total * stopLoss * profitLossRatio + (1 - winRate) * -total * stopLoss;
      total += pl;
      let fee = total * feeRate * 2;
      if (!feeMin && fee < 5) fee = 5;
      total -= fee;
      totalFee += fee;
    }
    const profitPercent = ((total - capital) / capital * 100).toFixed(1);
    const newResult = {
      total: formatTenThousand(total),
      profitPercent,
      totalFee: Math.round(totalFee)
    };

    if (JSON.stringify(newResult) !== JSON.stringify(lastResult)) {
      document.getElementById('calcResult').textContent = newResult.total;
      profitLossSpan.textContent = `盈亏: ${profitPercent}%`;
      feeDisplaySpan.textContent = `手续费: ${newResult.totalFee}`;
      lastResult = newResult;
    }
  } catch (e) {
    console.error('Error in updateFinalResult:', e);
  }
}

// 初始化柱子宽度
try {
  leftBars.forEach(b => {
    if (b.bar && b.display) {
      updateHeight(b.bar, b.display, b.value, b.max, b.type, true, b.bar.id);
    } else {
      console.error('Skipping initialization for invalid bar:', b);
    }
  });
  updateFinalResult();
} catch (e) {
  console.error('Error in initialization:', e);
}

// 为柱子添加拖动和滚轮功能
function addDragHandler(barObj, isHorizontal = false) {
  try {
    const bar = barObj.bar;
    const wrapper = bar.parentElement;
    let isDragging = false;
    let startX = 0;
    let startValue = 0;

    const startDrag = (e) => {
      if (e.target.classList.contains('label-horizontal') || e.target.classList.contains('bar-value-horizontal')) return;
      isDragging = true;
      wrapper.style.cursor = 'grabbing';
      bar.classList.add('dragging');
      startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
      startValue = barObj.value;
      e.preventDefault();
      console.log('startDrag:', bar.id);
    };

    const moveDrag = (e) => {
      if (!isDragging) return;
      try {
        const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const deltaX = currentX - startX;
        const container = wrapper.getBoundingClientRect();
        const maxDimension = isHorizontal ? container.width * 0.7 : container.height * 0.7;
        const sensitivity = barObj.max / maxDimension * 0.4;
        let newValue = startValue + deltaX * sensitivity;
        newValue = Math.max(0, Math.min(barObj.max, newValue));
        if (bar.id === 'leftBar4') {
          newValue = lerp(barObj.value, newValue, 0.2);
        } else {
          newValue = Math.round(newValue / barObj.step) * barObj.step;
        }
        barObj.value = newValue;
        updateHeight(bar, barObj.display, barObj.value, barObj.max, barObj.type, isHorizontal, bar.id);
        updateFinalResult();
        if (newValue <= 0 || newValue >= barObj.max) {
          if (navigator.vibrate) navigator.vibrate(50);
        }
      } catch (e) {
        console.error('Error in moveDrag:', e, bar.id);
      }
    };

    const endDrag = () => {
      if (isDragging) {
        isDragging = false;
        wrapper.style.cursor = 'grab';
        bar.classList.remove('dragging');
        barObj.value = Math.round(barObj.value / barObj.step) * barObj.step;
        updateHeight(bar, barObj.display, barObj.value, barObj.max, barObj.type, isHorizontal, bar.id);
        updateFinalResult();
        console.log('endDrag:', bar.id, 'value:', barObj.value);
      }
    };

    wrapper.addEventListener('mousedown', startDrag);
    wrapper.addEventListener('touchstart', startDrag, { passive: false });

    document.addEventListener('mousemove', throttle(moveDrag, 10));
    document.addEventListener('touchmove', throttle(moveDrag, 10), { passive: false });

    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);

    wrapper.addEventListener('wheel', (e) => {
      if (e.target.classList.contains('label-horizontal') || e.target.classList.contains('bar-value-horizontal')) return;
      e.preventDefault();
      try {
        const delta = Math.sign(e.deltaY) * barObj.step;
        let newValue = barObj.value - delta;
        newValue = Math.max(0, Math.min(barObj.max, newValue));
        newValue = Math.round(newValue / barObj.step) * barObj.step;
        barObj.value = newValue;
        updateHeight(bar, barObj.display, barObj.value, barObj.max, barObj.type, isHorizontal, bar.id);
        updateFinalResult();
        if (newValue <= 0 || newValue >= barObj.max) {
          if (navigator.vibrate) navigator.vibrate(50);
        }
      } catch (e) {
        console.error('Error in wheel:', e, bar.id);
      }
    });
  } catch (e) {
    console.error('Error in addDragHandler:', e, barObj.bar?.id);
  }
}

// 为所有柱子添加拖动和滚轮功能
try {
  leftBars.forEach(b => {
    if (b.bar && b.display) {
      addDragHandler(b, true);
    } else {
      console.error('Skipping addDragHandler for invalid bar:', b);
    }
  });
} catch (e) {
  console.error('Error in adding drag handlers:', e);
}

// 费用输入处理函数
function handleFeeInput() {
  try {
    const input = document.createElement('input');
    input.type = 'number';
    input.value = '';
    input.style.width = '60px';
    input.style.fontSize = '20px';
    input.style.color = getComputedStyle(document.body).getPropertyValue('--label-color');
    feeValueSpan.replaceWith(input);
    input.focus();

    input.addEventListener('blur', () => {
      try {
        feeValue = Math.max(0, parseFloat(input.value) || 1);
        input.replaceWith(feeValueSpan);
        feeValueSpan.textContent = feeValue.toFixed(1);
        updateFinalResult();
      } catch (e) {
        console.error('Error in fee input blur:', e);
      }
    });

    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') input.blur();
    });
  } catch (e) {
    console.error('Error in handleFeeInput:', e);
  }
}

try {
  if (feeValueSpan && feeTextSpan && feeMinCheck) {
    feeValueSpan.addEventListener('click', handleFeeInput);
    feeTextSpan.addEventListener('click', handleFeeInput);

    feeValueSpan.addEventListener('wheel', (e) => {
      try {
        e.preventDefault();
        const delta = -Math.sign(e.deltaY) * 0.1;
        feeValue = Math.max(0, parseFloat((feeValue + delta).toFixed(1)));
        feeValueSpan.textContent = feeValue.toFixed(1);
        updateFinalResult();
      } catch (e) {
        console.error('Error in feeValueSpan wheel:', e);
      }
    });

    feeTextSpan.addEventListener('wheel', (e) => {
      try {
        e.preventDefault();
        const delta = -Math.sign(e.deltaY) * 0.1;
        feeValue = Math.max(0, parseFloat((feeValue + delta).toFixed(1)));
        feeValueSpan.textContent = feeValue.toFixed(1);
        updateFinalResult();
      } catch (e) {
        console.error('Error in feeTextSpan wheel:', e);
      }
    });

    feeMinCheck.addEventListener('change', updateFinalResult);
  } else {
    console.error('Cannot attach fee event listeners due to missing elements');
  }
} catch (e) {
  console.error('Error in setting up event listeners:', e);
}
} catch (e) {
  console.error('Error in main script:', e);
}
</script>
</body>
</html>
